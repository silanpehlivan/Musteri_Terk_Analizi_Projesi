<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ¼ÅŸteri Terk Analizi (MLP) - Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container my-5">
        <header class="text-center mb-5">
    <h1>ğŸ‘¤ MÃ¼ÅŸteri Terk Analizi</h1>
    <p class="subtitle">MLP Modeli ile Telco MÃ¼ÅŸterilerinin Abonelik Ä°ptali OlasÄ±lÄ±ÄŸÄ±nÄ± Tahmin Edin.</p>
</header>
                    

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm p-4 h-100">
                    <h5 class="card-title text-success mb-4">MÃ¼ÅŸteri Ã–zelliklerini Girin</h5>
                    <form id="churn-form">
                        <div class="mb-3">
                            <label class="form-label">SÃ¶zleÅŸme SÃ¼resi (Ay)</label>
                            <input type="number" class="form-control" name="tenure" value="12" min="1" max="72" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">AylÄ±k Ã–deme (TL)</label>
                            <input type="number" class="form-control" name="MonthlyCharges" value="70.50" step="0.01" min="18" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Toplam Ã–deme (TL)</label>
                            <input type="number" class="form-control" name="TotalCharges" value="846.00" step="0.01" min="0" required>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ä°nternet Servisi</label>
                                <select class="form-select" name="InternetService">
                                    <option value="DSL">DSL</option>
                                    <option value="Fiber optic">Fiber Optik</option>
                                    <option value="No">Yok</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SÃ¶zleÅŸme Tipi</label>
                                <select class="form-select" name="Contract">
                                    <option value="Month-to-month">AylÄ±k</option>
                                    <option value="One year">YÄ±llÄ±k</option>
                                    <option value="Two year">Ä°ki YÄ±llÄ±k</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ã–deme YÃ¶ntemi</label>
                            <select class="form-select" name="PaymentMethod">
                                <option value="Electronic check">E-Ã‡ek</option>
                                <option value="Mailed check">Posta Ã‡eki</option>
                                <option value="Bank transfer (automatic)">Banka Transferi</option>
                                <option value="Credit card (automatic)">Kredi KartÄ±</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">YaÅŸlÄ± VatandaÅŸ</label>
                                <select class="form-select" name="SeniorCitizen">
                                    <option value="0">HayÄ±r</option>
                                    <option value="1">Evet</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ã‡evrimiÃ§i GÃ¼venlik</label>
                                <select class="form-select" name="OnlineSecurity">
                                    <option value="No">HayÄ±r</option>
                                    <option value="Yes">Evet</option>
                                    <option value="No internet service">Ä°nternet Yok</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100 mt-3">ğŸ“ˆ Tahmin Et</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm p-4 h-100">
                    <h5 class="card-title text-primary mb-4">Tahmin SonuÃ§larÄ±</h5>
                    
                    <div id="result" class="alert alert-secondary text-center">
                        Ã–zellikleri girin ve tahmin butonuna basÄ±n.
                    </div>

                    <div id="model-risks" class="d-flex justify-content-between mt-3 mb-3" style="gap:12px">
                        <div class="card p-2 text-center flex-fill">
                            <div class="small text-muted">LightGBM Risk</div>
                            <div id="lgb-risk" class="h4">â€”</div>
                        </div>
                        <div class="card p-2 text-center flex-fill">
                            <div class="small text-muted">Deep NN Risk</div>
                            <div id="deep-risk" class="h4">â€”</div>
                        </div>
                        <div class="card p-2 text-center flex-fill">
                            <div class="small text-muted">Stack Risk</div>
                            <div id="stack-risk" class="h4">â€”</div>
                        </div>
                    </div>
                    <div id="used-model" class="text-center mt-2">
                        <span id="used-model-badge" class="badge used-badge">KullanÄ±lan model: â€”</span>
                    </div>

                    

                    <h5 class="card-title text-secondary mt-4 mb-3">EÄŸitim Metrikleri</h5>
                    <div style="height: 250px;">
                        <canvas id="metricChart"></canvas>
                    </div>
                    <p id="best-model-caption" class="small text-muted mt-2">En iyi model: hesaplanÄ±yor...</p>
                    <div id="chart-explanation" class="mt-3 text-muted small">
                        <!-- Filled by JS -->
                    </div>
                    
                    <!-- Removed detailed metric summary cards per user request; chart explanation remains above -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper to parse and update risk cards (available to both load and predict handlers)
        function parseProbForDisplay(v){
            if (v === undefined || v === null) return NaN;
            if (typeof v === 'string') {
                v = v.trim();
                if (v.endsWith('%')) return parseFloat(v.replace('%',''));
                v = parseFloat(v);
            }
            if (isNaN(v)) return NaN;
            if (v <= 1) return v * 100; // fraction -> percent
            return v; // already percent
        }

        function updateRiskCard(id, rawValue){
            const el = document.getElementById(id);
            if (!el) return;
            const pct = parseProbForDisplay(rawValue);
            const card = el.parentElement;
            card.classList.remove('risk-low','risk-medium','risk-high');
            if (isNaN(pct)){
                el.innerText = 'â€”';
                return;
            }
            el.innerText = pct.toFixed(2) + '%';
            if (pct >= 60) card.classList.add('risk-high');
            else if (pct >= 50) card.classList.add('risk-medium');
            else card.classList.add('risk-low');
        }

        // Grafik Verisi: Sunucudan metriÌ‡kleri al ve iki model iÌ‡Ã§in karÅŸÄ±laÅŸtÄ±rmalÄ± Ã§ubuk grafik Ã§iz
        async function loadAndRenderMetrics() {
            const resp = await fetch('/metrics');
            const data = await resp.json();

            // Compare previous Jupyter MLP vs current stacked model
            const labels = ['Accuracy', 'Precision', 'Recall', 'F1'];

            const jupyter = data.junit || data['jupyter_mlp'] || {accuracy:0, precision:0, recall:0, f1:0};
            const stack = data.stack || {accuracy:0, precision:0, recall:0, f1:0};

            const jupyterVals = [jupyter.accuracy, jupyter.precision, jupyter.recall, jupyter.f1].map(v => Math.round(v * 100 * 100) / 100);
            const stackVals = [stack.accuracy, stack.precision, stack.recall, stack.f1].map(v => Math.round(v * 100 * 100) / 100);

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Jupyter MLP (%)',
                        data: jupyterVals,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)'
                    },
                    {
                        label: 'Stacked Model (%)',
                        data: stackVals,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)'
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            };

            // Destroy existing chart if exists
            if (window.metricChartInstance) {
                window.metricChartInstance.destroy();
            }

            window.metricChartInstance = new Chart(document.getElementById('metricChart'), config);

            // Update caption and explanation under the chart
            const jF1 = (jupyter.f1 || 0) * 100;
            const sF1 = (stack.f1 || 0) * 100;
            const best = sF1 >= jF1 ? {name: 'Stacked Model', f1: sF1} : {name: 'Jupyter MLP', f1: jF1};
            document.getElementById('best-model-caption').innerText = `En iyi model: ${best.name} â€” F1 Skoru ${best.f1.toFixed(2)}%`;

            // Brief explanations for the chart metrics
            const explainEl = document.getElementById('chart-explanation');
            explainEl.innerHTML = `
                <strong>Grafik AÃ§Ä±klamasÄ±</strong><br>
                - <strong>Accuracy</strong>: Modelin yaptÄ±ÄŸÄ± tÃ¼m tahminlerin ne kadarÄ±nÄ±n gerÃ§ekte doÄŸru olduÄŸunun genel oranÄ±dÄ±r.<br>
                - <strong>Precision</strong>: Modelin "Evet, bu pozitif (terk edecek)" dediÄŸi tahminlerin, gerÃ§ekten doÄŸru Ã§Ä±kma oranÄ±dÄ±r.<br>
                - <strong>Recall</strong>: GerÃ§ekten terk eden mÃ¼ÅŸterilerin yÃ¼zde kaÃ§Ä±nÄ± modelin doÄŸru bir ÅŸekilde tespit edebildiÄŸini gÃ¶sterir.<br>
                - <strong>F1</strong>: Modelin hem gereksiz yere alarm vermemesini hem de kritik kayÄ±plarÄ± kaÃ§Ä±rmamasÄ±nÄ± saÄŸlayan, genel performansÄ±n en gÃ¼venilir gÃ¶stergesidir.<br>
                <br>
                Bu tabloda her iki modelin performans metrikleri karÅŸÄ±laÅŸtÄ±rÄ±lmaktadÄ±r. Ã–rneÄŸin, bir modelin <em>precision</em> deÄŸeri yÃ¼ksekse, yalnÄ±zca yÃ¼ksek riskli olarak belirlenen mÃ¼ÅŸterilere temkinli bir mÃ¼dahalede bulunmak daha avantajlÄ± olabilir; ancak <em>recall</em> dÃ¼ÅŸÃ¼klÃ¼ÄŸÃ¼, bazÄ± gerÃ§ek kayÄ±p vakalarÄ±nÄ±n gÃ¶zden kaÃ§Ä±rÄ±lmasÄ±na neden olabilir. Stacked modelin F1 skoru daha yÃ¼ksekse, bu durum genel Precision/Recall dengesi aÃ§Ä±sÄ±ndan Ã¼stÃ¼n bir performans sergilediÄŸini gÃ¶sterir.
            `;
            // Initialize Bootstrap tooltips for explanation icons
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });

            // Try to initialize per-model risk cards from metrics if present
            function getProbFromMetrics(obj){
                if (!obj) return null;
                return obj.avg_probability || obj.mean_probability || obj.avg_predicted_probability || obj.predicted_positive_rate || obj.positive_rate || null;
            }

            updateRiskCard('lgb-risk', getProbFromMetrics(data.lightgbm) || getProbFromMetrics(data.lgbm) );
            updateRiskCard('deep-risk', getProbFromMetrics(data.deep_nn) || getProbFromMetrics(data.deep));
            updateRiskCard('stack-risk', getProbFromMetrics(data.stack));
        }

        window.onload = function() {
            loadAndRenderMetrics();
        };

        // Flask API Ä°letiÅŸim Kodu
        document.getElementById('churn-form').addEventListener('submit', async function(e) {
            e.preventDefault(); 

            // Formdan verileri toplama
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // TÃ¼m sayÄ±sal alanlarÄ± float/int yapma (app.py iÃ§in kritik)
            data.tenure = parseInt(data.tenure);
            data.MonthlyCharges = parseFloat(data.MonthlyCharges);
            data.TotalCharges = parseFloat(data.TotalCharges);
            data.SeniorCitizen = parseInt(data.SeniorCitizen);

            const resultDiv = document.getElementById('result');
            resultDiv.className = 'alert alert-info text-center';
            resultDiv.innerHTML = 'Tahmin hesaplanÄ±yor...';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show stacked/result text
                    const prob = parseFloat(result.churn_probability.replace('%', ''));
                    let alertClass, icon;

                    if (prob >= 60) { // EÅŸik 0.60 (Modelin nihai eÅŸiÄŸi)
                        alertClass = 'alert-danger';
                        icon = 'ğŸš¨';
                    } else if (prob >= 50) {
                        alertClass = 'alert-warning';
                        icon = 'âš ï¸';
                    } else {
                        alertClass = 'alert-success';
                        icon = 'âœ…';
                    }

                    const formattedProb = prob.toFixed(2) + '%';
                    resultDiv.className = `alert ${alertClass} text-center`;
                    resultDiv.innerHTML = `
                        <h4>${icon} ${result.result_text}</h4>
                        <p class="h3 mb-0">${formattedProb}</p>
                    `;

                    // Show which model was used for the final decision
                    const usedModelEl = document.getElementById('used-model');
                    if (usedModelEl) {
                        const badge = document.getElementById('used-model-badge');
                        const modelMap = { 'stack': 'Stacked Model', 'lightgbm': 'LightGBM', 'deep_nn': 'Deep NN', 'jupyter_mlp': 'Jupyter MLP' };
                        const used = result.used_model || 'â€”';
                        const label = modelMap[used] || used;
                        if (badge) {
                            badge.innerText = `KullanÄ±lan model: ${label}`;
                            // color the badge according to overall churn probability for emphasis
                            badge.classList.remove('used-good','used-warning','used-high');
                            const pct = parseFloat(result.churn_probability.replace('%',''));
                            if (!isNaN(pct)) {
                                if (pct >= 60) badge.classList.add('used-high');
                                else if (pct >= 50) badge.classList.add('used-warning');
                                else badge.classList.add('used-badge');
                            }
                        }
                    }

                    // Update risk cards with model probabilities (if present)
                    updateRiskCard('lgb-risk', result.lgb_probability);
                    updateRiskCard('deep-risk', result.deep_probability);
                    updateRiskCard('stack-risk', result.stack_probability);

                } else {
                    resultDiv.className = 'alert alert-danger text-center';
                    resultDiv.innerHTML = `Hata: ${result.error}`;
                }

            } catch (error) {
                resultDiv.className = 'alert alert-danger text-center';
                resultDiv.innerHTML = `BaÄŸlantÄ± HatasÄ±: Sunucuya ulaÅŸÄ±lamÄ±yor.`;
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>